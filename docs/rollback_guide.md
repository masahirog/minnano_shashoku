# ロールバック手順書

**バージョン:** 1.0
**最終更新日:** 2025-12-03
**対象:** Phase 1 MVP システム導入時のロールバック

---

## 目次

1. [ロールバックの判断基準](#ロールバックの判断基準)
2. [ロールバック手順](#ロールバック手順)
3. [部分ロールバック](#部分ロールバック)
4. [完全ロールバック](#完全ロールバック)
5. [ロールバック後の対応](#ロールバック後の対応)

---

## ロールバックの判断基準

### 即座にロールバックすべき状況

以下のいずれかに該当する場合は、即座にロールバックを実施してください。

#### 重大度：高（即座にロールバック）

1. **データ損失が発生**
   - 案件データが消失
   - マスタデータが破損
   - 復旧不可能なデータ破損

2. **システムが完全に停止**
   - アプリケーションが起動しない
   - データベースに接続できない
   - 全ユーザーがアクセス不能

3. **データの整合性が崩壊**
   - 案件と企業の紐付けが全て外れる
   - 金額計算が完全に狂う
   - マスタデータの関連が崩壊

#### 重大度：中（一時的にスプシ併用、修正可能ならシステム継続）

1. **一部機能が動作しない**
   - PDF出力ができない
   - カレンダー表示がおかしい
   - 検索機能が動作しない

2. **パフォーマンス問題**
   - ページ読み込みに1分以上かかる
   - タイムアウトが頻発
   - データベースが高負荷

3. **一部データの不整合**
   - 特定企業のデータがおかしい
   - 一部の案件が重複
   - 配送シートに一部漏れがある

#### 重大度：低（修正対応、ロールバック不要）

1. **UI/UX の問題**
   - ボタンの配置がおかしい
   - 文言が不適切
   - 色が見づらい

2. **軽微なバグ**
   - 特定条件でエラーが出る（回避可能）
   - 通知メールが届かない
   - ソート順がおかしい

---

## ロールバック手順

### 前提条件

- スプレッドシートのバックアップが存在すること
- データベースのバックアップが存在すること
- スタッフが旧運用（スプシ）に戻る準備ができていること

### ロールバック決定者

以下の権限者のいずれかが判断：
- システム管理者
- プロジェクトマネージャー
- 業務責任者

### ロールバックの通知

**即座に以下を実施:**

1. **全スタッフに緊急連絡**
   ```
   件名: 【緊急】システムロールバックのお知らせ

   システムに重大な問題が発生したため、
   一時的にスプレッドシート運用に戻します。

   以下の対応をお願いします：
   1. 新しいシステムの使用を停止
   2. スプレッドシートでの作業を再開
   3. 詳細は追って連絡します
   ```

2. **システムメンテナンスモード有効化**
   ```bash
   # Herokuの場合
   heroku maintenance:on
   ```

---

## 部分ロールバック

特定機能のみ問題がある場合、その機能だけをスプシ運用に戻す方法です。

### パターン1: 配送シート出力のみスプシに戻す

**状況:** PDF出力が動作しないが、他の機能は正常

**手順:**
1. システムでの案件管理は継続
2. 配送シート出力のみスプレッドシートで手動作成
3. データはシステムからエクスポート
4. スプレッドシートで整形・印刷

### パターン2: 新規案件作成のみスプシに戻す

**状況:** 案件作成時にバリデーションエラーが頻発

**手順:**
1. 新規案件はスプレッドシートで管理
2. 既存案件の閲覧・編集はシステムで継続
3. 定期的にスプシからシステムにインポート

### パターン3: カレンダー表示のみスプシに戻す

**状況:** カレンダー表示が重い・正しく表示されない

**手順:**
1. 案件の一覧表示で代用
2. カレンダー形式はスプレッドシートで確認
3. エクスポート機能でデータをスプシに移行

---

## 完全ロールバック

システム全体をスプレッドシート運用に戻す方法です。

### Phase 1: 緊急対応（5分以内）

#### Step 1: システムの停止

```bash
# Heroku本番環境の場合
heroku maintenance:on

# または、アプリケーションを停止
heroku ps:scale web=0
```

#### Step 2: スタッフへの通知

- Slack/メールで全スタッフに緊急連絡
- スプレッドシート運用への切り替えを指示

#### Step 3: スプレッドシートのアクセス権限変更

1. スプレッドシートを編集可能に変更
2. バックアップから最新版を復元（必要に応じて）

### Phase 2: データのエクスポート（30分以内）

#### Step 1: データベースのバックアップ取得

```bash
# 本番環境のバックアップ
heroku pg:backups:capture
heroku pg:backups:download

# ローカルに保存
mv latest.dump rollback_backup_$(date +%Y%m%d_%H%M%S).dump
```

#### Step 2: データのエクスポート

システムに登録された最新データをスプレッドシートに反映します。

```bash
# コンソールでCSVエクスポート
rails c

# 企業データ
require 'csv'
CSV.open('export_companies.csv', 'w') do |csv|
  csv << ['企業名', '請求先', '連絡先']
  Company.find_each do |c|
    csv << [c.name, c.invoice_recipient, c.contact_email]
  end
end

# 案件データ（直近3ヶ月分）
CSV.open('export_orders.csv', 'w') do |csv|
  csv << ['予定日', '企業名', '飲食店名', 'メニュー', '食数', 'ステータス']
  Order.where('scheduled_date >= ?', 3.months.ago).find_each do |o|
    csv << [
      o.scheduled_date,
      o.company&.name,
      o.restaurant&.name,
      o.menu&.name,
      o.default_meal_count,
      o.status
    ]
  end
end
```

#### Step 3: スプレッドシートへのインポート

1. エクスポートしたCSVをGoogleスプレッドシートにインポート
2. 既存データとマージ
3. 重複を削除
4. データの整合性を確認

### Phase 3: 移行データの確認（1時間以内）

#### 確認項目

1. **マスタデータの整合性**
   - 企業数が一致するか
   - 飲食店数が一致するか
   - メニュー数が一致するか

2. **案件データの整合性**
   - 直近3ヶ月の案件が全て含まれているか
   - 未来の案件が全て含まれているか
   - ステータスが正しいか

3. **計算の確認**
   - 配送予定件数
   - 月次集計
   - 請求金額

### Phase 4: 通常運用への復帰（2時間以内）

#### Step 1: スタッフへの説明

1. ロールバックの理由を説明
2. スプレッドシート運用の手順を再確認
3. 今後の予定（いつ再開するか）を共有

#### Step 2: 業務再開

1. 各スタッフがスプレッドシートにアクセスできることを確認
2. 通常業務を再開
3. システムの問題を調査・修正

---

## ロールバック後の対応

### 原因調査

1. **ログの確認**
   ```bash
   # Herokuログ確認
   heroku logs --tail --num=1000 > error_logs.txt

   # エラー箇所の特定
   grep ERROR error_logs.txt
   ```

2. **データベースの確認**
   ```bash
   rails c
   # データの整合性チェック
   # パフォーマンス問題の調査
   ```

3. **コードの確認**
   - 最近のコミット履歴を確認
   - 変更内容のレビュー

### 修正計画の作成

1. **問題の特定**
   - 根本原因を明確にする
   - 再発防止策を検討

2. **修正スケジュール**
   - 修正期間の見積もり
   - テスト期間の確保
   - 再導入日の設定

3. **リスク評価**
   - 同じ問題が再発しないか
   - 他の影響がないか

### 再導入の準備

1. **修正完了**
   - テスト環境で十分にテスト
   - レビュー完了

2. **テストデータでの確認**
   - 本番環境と同等のデータ量でテスト
   - パフォーマンステスト

3. **スタッフへの説明**
   - 修正内容の共有
   - 再導入スケジュールの確認
   - 万が一の場合のロールバック手順の再確認

---

## 緊急連絡先

### システム関連

- **開発担当**: Claude
- **サーバー管理**: Heroku Support
- **データベース**: PostgreSQL Support

### 業務関連

- **業務責任者**: [担当者名]
- **プロジェクトマネージャー**: [担当者名]

---

## ロールバックチェックリスト

### 準備

- [ ] データベースのバックアップ取得完了
- [ ] スプレッドシートのバックアップ確認
- [ ] スタッフへの連絡準備完了

### 実行

- [ ] システムのメンテナンスモード有効化
- [ ] スタッフへの緊急連絡送信
- [ ] データのエクスポート完了
- [ ] スプレッドシートへのインポート完了
- [ ] データの整合性確認完了

### 確認

- [ ] マスタデータの整合性確認
- [ ] 案件データの整合性確認
- [ ] スタッフが業務再開できることを確認
- [ ] 問題の原因調査開始

### 事後対応

- [ ] 原因の特定完了
- [ ] 修正計画の作成
- [ ] 修正完了
- [ ] 再テスト完了
- [ ] 再導入スケジュールの決定
