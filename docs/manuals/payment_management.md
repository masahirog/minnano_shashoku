# 入金管理操作マニュアル

**Phase 2: 請求・支払い管理システム**

---

## 目次

1. [概要](#概要)
2. [入金の登録](#入金の登録)
3. [入金履歴の確認](#入金履歴の確認)
4. [支払状況レポート](#支払状況レポート)
5. [期限超過アラート](#期限超過アラート)
6. [トラブルシューティング](#トラブルシューティング)

---

## 概要

入金管理機能では、請求書に対する入金を記録し、支払状況をリアルタイムで追跡できます。

### 主な機能

- **入金登録**: 振込やクレジットカードなどの入金を記録
- **自動計算**: 入金額から残高を自動計算
- **ステータス更新**: 支払状況を自動更新
- **レポート**: 月次支払状況レポート
- **アラート**: 期限超過の自動検出

---

## 入金の登録

### 新規入金の登録

1. **登録画面を開く**
   - 左メニュー「Payments」→「New Payment」
   - または請求書詳細画面から「入金登録」

2. **入力項目**

   | 項目 | 必須 | 説明 | 例 |
   |------|------|------|-----|
   | Invoice | ✓ | 対象請求書 | INV-202512-0001 |
   | Payment Date | ✓ | 入金日 | 2025/12/15 |
   | Amount | ✓ | 入金額（円） | 50000 |
   | Payment Method | - | 支払方法 | 銀行振込 |
   | Reference Number | - | 振込番号等 | 123456789 |
   | Notes | - | 備考 | 12月分 一部入金 |

3. **支払方法の選択肢**
   - 銀行振込
   - クレジットカード
   - 現金
   - その他

4. **保存**
   - 「Create Payment」ボタンをクリック
   - 請求書の支払ステータスが自動更新されます

### 自動更新される内容

入金登録後、以下が自動的に更新されます：

- **請求書の支払ステータス**:
  - 全額入金 → `paid`（支払済み）
  - 一部入金 → `partial`（一部支払）
  - 残額あり → `unpaid`（未払い）

- **請求書の残高**:
  - `remaining_balance` = 合計金額 - 入金合計

### バリデーション

以下の場合、エラーになります：

- 入金日が未入力
- 入金額が0円以下
- **入金額が残高を超える場合**
  ```
  エラー: 「は残高 50,000円 を超えることはできません」
  ```

### 注意事項

- 入金額は必ず正の整数で入力してください
- 残高を超える入金はできません
- 一度登録した入金は編集可能ですが、削除すると請求書のステータスも変更されます

---

## 入金履歴の確認

### 入金一覧の確認

1. **一覧画面にアクセス**
   - 左メニュー「Payments」をクリック

2. **表示内容**
   - 入金日
   - 請求書番号
   - 企業名
   - 入金額
   - 支払方法
   - 参照番号

3. **並び替え**
   - デフォルト: 入金日の新しい順
   - カラムヘッダーをクリックで並び替え可能

### 請求書ごとの入金履歴

1. **請求書詳細画面を開く**
   - `/admin/invoices/{id}`

2. **Payments セクション**
   - 該当請求書の全入金履歴を表示
   - 入金日、金額、支払方法を一覧表示
   - 入金合計と残高を表示

### 入金の編集・削除

1. **編集**
   - 入金一覧から対象の入金をクリック
   - 「Edit Payment」ボタンで編集画面へ
   - 金額や入金日を修正可能

2. **削除**
   - 入金詳細画面の「Destroy Payment」ボタン
   - 確認ダイアログで「OK」
   - **注意**: 削除すると請求書の支払ステータスも自動更新されます

---

## 支払状況レポート

### 月次支払状況レポートの確認

1. **レポート画面にアクセス**
   - 左メニュー「Reports」をクリック
   - または URL: `/admin/reports`

2. **対象月の選択**
   ```
   年: 2025
   月: 12
   [表示]ボタンをクリック
   ```

3. **レポート内容**

#### サマリー情報
- 総請求書数
- 総請求額
- 支払済み額
- 未払い額
- 支払率（%）

#### 支払ステータス別集計
- 支払済み（件数、金額）
- 一部支払（件数、金額、入金済み額）
- 未払い（件数、金額）
- 期限超過（件数、金額）

#### 企業別支払状況
- 企業名
- 請求書数
- 総請求額
- 支払済み額
- 未払い額

#### 期限超過請求書
- 請求書番号
- 企業名
- 支払期限
- 請求額
- 支払済み額
- 残高
- 超過日数

#### 最近の入金（直近10件）
- 入金日
- 金額
- 支払方法
- 請求書番号
- 企業名

### レポートの出力

1. **PDF出力**
   - 「PDF出力」ボタンをクリック
   - ファイル名: `payment_report_YYYY_MM.pdf`

2. **CSV出力**
   - 「CSV出力」ボタンをクリック
   - ファイル名: `payment_report_YYYY_MM.csv`
   - Excelで開いて分析可能

### グラフ表示

**支払ステータス別の円グラフ**:
- 支払済み（緑）
- 一部支払（オレンジ）
- 未払い（青）
- 期限超過（赤）

**企業別支払状況（上位10社）**:
- 支払済み額（緑）
- 未払い額（赤）

---

## 期限超過アラート

### 期限超過チェックの仕組み

**自動チェック（推奨設定）**:
- 毎日深夜1時に自動実行（要：Sidekiq Scheduler設定）
- 期限超過の請求書を自動検出
- payment_status を 'overdue' に更新
- 管理者にメール通知（未実装）

**手動チェック**:
```bash
# 期限超過チェックを手動実行
bin/rails invoices:check_overdue
```

### 期限超過の確認

1. **請求書一覧でフィルター**
   - Payment Status: `overdue` で絞り込み

2. **レポートで確認**
   - 月次支払状況レポートの「期限超過請求書」セクション
   - 超過日数順に表示

### 督促の手順

1. **期限超過請求書の確認**
   - 超過日数を確認
   - 企業の担当者情報を確認

2. **督促メール送信（手動）**
   - 請求書PDFを添付
   - 丁寧な文面で支払いを依頼

3. **記録の更新**
   - 請求書の Notes に督促日を記録
   ```
   2025/12/15: 督促メール送信（1回目）
   ```

---

## トラブルシューティング

### Q1. 入金を登録できない（残高超過エラー）

**エラーメッセージ**:
```
Amount は残高 50,000円 を超えることはできません
```

**原因**:
- 入金額が請求書の残高を超えている

**解決方法**:
1. 請求書の詳細を確認
   - 合計金額: 100,000円
   - 既存入金: 50,000円
   - 残高: 50,000円
2. 入金額を残高以内に修正
   - 例: 50,000円 → 正常に登録可能
   - 例: 60,000円 → エラー

### Q2. 入金を登録したのにステータスが更新されない

**確認事項**:
1. ページをリロード（F5キー）
2. 請求書の合計金額と入金合計を確認

**解決方法**:
- 手動でステータスを更新:
```ruby
# Rails consoleで実行
invoice = Invoice.find(請求書ID)
invoice.update_payment_status
```

### Q3. 入金を間違えて登録してしまった

**削除の手順**:
1. 入金一覧から対象の入金を開く
2. 「Destroy Payment」ボタンをクリック
3. 確認ダイアログで「OK」
4. 請求書の支払ステータスが自動的に再計算されます

**再登録**:
- 削除後、正しい内容で新規登録

### Q4. レポートに表示されない入金がある

**確認事項**:
1. 入金日が対象月に含まれているか
2. 請求書の billing_period_start が対象月か

**注意**:
- レポートは **請求書の請求期間** で集計されます
- **入金日** ではなく **請求期間** が基準です

### Q5. 期限超過アラートが届かない

**確認事項**:
1. バッチ処理が実行されているか
2. メール設定が正しいか

**手動実行**:
```bash
# 期限超過チェック
bin/rails invoices:check_overdue

# アラートメール送信（未実装）
# bin/rails invoices:send_overdue_alerts
```

---

## ベストプラクティス

### 入金登録のタイミング

- **推奨**: 入金確認後、当日中に登録
- **理由**: 支払状況をリアルタイムで把握できる

### 参照番号の活用

- 銀行振込の場合: 振込番号を記録
- クレジット決済の場合: トランザクションIDを記録
- 現金の場合: 領収書番号を記録

### 定期チェック

- **週次**: 未払い請求書の確認
- **月次**: 支払状況レポートの確認
- **月初**: 前月の期限超過チェック

---

## 関連ページ

- [請求書管理操作マニュアル](./invoice_management.md)
- [データ移行手順書](../migration/phase2_data_migration.md)
- [システム構成ドキュメント](../architecture/phase2_system_architecture.md)

---

**更新履歴**:
- 2025-12-04: 初版作成
