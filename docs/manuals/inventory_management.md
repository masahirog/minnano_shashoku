# 在庫管理操作マニュアル

**Phase 2: 在庫管理システム**

---

## 目次

1. [概要](#概要)
2. [備品マスタの管理](#備品マスタの管理)
3. [在庫の確認・更新](#在庫の確認更新)
4. [在庫移動の記録](#在庫移動の記録)
5. [在庫補充アラート](#在庫補充アラート)
6. [棚卸し作業](#棚卸し作業)
7. [トラブルシューティング](#トラブルシューティング)

---

## 概要

在庫管理機能では、企業貸与備品・飲食店貸与備品・使い捨て備品の在庫を拠点別に管理します。

### 主な機能

- **備品マスタ管理**: 備品の登録・編集
- **拠点別在庫管理**: 本社、倉庫、企業、飲食店ごとの在庫
- **在庫移動記録**: 入荷、消費、移動の履歴
- **自動アラート**: 在庫不足・在庫切れの検出
- **棚卸し**: 実地棚卸と在庫差異の管理

---

## 備品マスタの管理

### 備品の新規登録

1. **登録画面を開く**
   - 左メニュー「Supplies」→「New Supply」

2. **入力項目**

   | 項目 | 必須 | 説明 | 例 |
   |------|------|------|-----|
   | Name | ✓ | 備品名 | プラスチック容器（大） |
   | SKU | ✓ | 管理コード（ユニーク） | CONT-L-001 |
   | Category | ✓ | カテゴリ | 使い捨て備品 |
   | Unit | ✓ | 単位 | 個 |
   | Reorder Point | - | 再注文ポイント | 50 |
   | Storage Guideline | - | 保管方法 | 直射日光を避けて保管 |
   | Is Active | ✓ | 使用状況 | チェック（有効） |

3. **カテゴリの種類**
   - **使い捨て備品**: プラスチック容器、割り箸、紙ナプキン等
   - **企業貸与備品**: 保温器、トレー、配膳台等
   - **飲食店貸与備品**: 大型保温器、業務用器材等

4. **保存**
   - 「Create Supply」ボタンをクリック

### 備品の編集

1. **編集画面を開く**
   - 備品一覧から対象をクリック
   - 「Edit Supply」ボタン

2. **編集可能な項目**
   - すべての項目が編集可能
   - SKUは慎重に変更（他のデータとの整合性を確認）

### 備品の無効化

不要になった備品を削除せずに無効化:
1. 備品の編集画面を開く
2. 「Is Active」のチェックを外す
3. 「Update Supply」ボタンをクリック

**注意**: 削除は推奨しません（履歴データが失われます）

---

## 在庫の確認・更新

### 在庫の確認方法

#### 方法1: 備品ごとの在庫確認

1. **備品詳細画面を開く**
   - 左メニュー「Supplies」→ 対象備品をクリック

2. **Supply Stocks セクション**
   - 拠点別の在庫数を表示
   - Location Name: 拠点名
   - Quantity: 在庫数

3. **総在庫数の確認**
   - `total_stock` メソッドで全拠点の合計を計算
   - 画面上部に表示

#### 方法2: 拠点ごとの在庫確認

1. **在庫一覧画面**
   - 左メニュー「Supply Stocks」

2. **フィルター**
   - Location Name で絞り込み
   - Supply で絞り込み

### 在庫の更新（手動）

**SupplyStock の直接編集**:

1. 「Supply Stocks」一覧から対象をクリック
2. 「Edit Supply Stock」ボタン
3. Quantity を更新
4. 「Update Supply Stock」ボタン

**注意**:
- 手動更新は推奨しません
- 在庫移動記録（SupplyMovement）を使用することを推奨

---

## 在庫移動の記録

在庫の増減は「在庫移動」として記録します。

### 移動タイプ

| タイプ | 説明 | 在庫への影響 |
|--------|------|--------------|
| 入荷 | 新規購入・入荷 | to_location の在庫が増加 |
| 消費 | 使用・廃棄 | from_location の在庫が減少 |
| 移動 | 拠点間移動 | from減少、to増加 |

### 入荷の記録

1. **移動記録画面を開く**
   - 左メニュー「Supply Movements」→「New Supply Movement」

2. **入力内容（入荷の例）**
   ```
   Supply: プラスチック容器（大）
   Movement Type: 入荷
   Quantity: 100
   Movement Date: 2025/12/04
   To Location Type: （空白 or 本社）
   To Location Name: 本社
   Notes: 12月分 追加発注
   ```

3. **保存**
   - 「Create Supply Movement」ボタンをクリック
   - 自動的に該当拠点の在庫が増加

### 消費の記録

**入力内容（消費の例）**:
```
Supply: プラスチック容器（大）
Movement Type: 消費
Quantity: 30
Movement Date: 2025/12/04
From Location Type: （空白）
From Location Name: 本社
Notes: 試食会で使用
```

### 拠点間移動の記録

**入力内容（移動の例）**:
```
Supply: 保温器
Movement Type: 移動
Quantity: 5
Movement Date: 2025/12/04
From Location Type: （空白）
From Location Name: 本社
To Location Type: Company
To Location ID: 企業ID
Notes: A社への配送
```

### 一括移動

複数の備品を一度に移動する場合:

1. **一括移動画面**
   - 左メニュー「Bulk Supply Movements」→「New」

2. **入力内容**
   - Movement Date: 移動日
   - From/To Location: 移動元・移動先
   - 複数の備品と数量をまとめて入力

---

## 在庫補充アラート

### アラートの仕組み

**自動チェック（推奨）**:
- 毎日深夜に自動実行（要：Sidekiq Scheduler設定）
- 在庫不足・在庫切れを検出
- 管理者にメール通知

**手動チェック**:
```bash
# 在庫チェックを手動実行
bin/rails supplies:check_stock
```

### アラートの種類

#### 1. 在庫不足（Low Stock）

**条件**:
- `total_stock <= reorder_point`
- かつ `total_stock > 0`

**対応**:
1. 発注数を計算
2. 発注手続き
3. 入荷後、「入荷」として記録

#### 2. 在庫切れ（Out of Stock）

**条件**:
- `total_stock == 0`

**対応**:
1. **緊急対応**: 他拠点から一時的に借用
2. 至急発注
3. 入荷後、在庫を補充

### 在庫状況の確認

**コマンド実行**:
```bash
# 在庫不足一覧を表示
bin/rails supplies:low_stock

# 全在庫をチェック
bin/rails supplies:check_stock
```

**出力例**:
```
在庫チェック結果:
総備品数: 50
在庫不足: 3件
在庫切れ: 1件

【在庫不足】
- プラスチック容器（大）: 現在 45個 (再注文点: 50個)
- 割り箸: 現在 80膳 (再注文点: 100膳)

【在庫切れ】
- 紙ナプキン: 0パック
```

---

## 棚卸し作業

### 棚卸しの手順

#### 1. 実地棚卸

1. **対象拠点を決定**
   - 例: 本社倉庫

2. **実地カウント**
   - 備品ごとに実際の在庫数を数える
   - 棚卸表に記録

3. **システム在庫との照合**
   - Supply Stocks 一覧でシステム在庫を確認
   - 実地カウント数と比較

#### 2. 差異の記録

**差異がある場合**:

1. Supply Stock の編集画面を開く
2. `Physical Count` フィールドに実地カウント数を入力
3. 保存

**差異の調整**:

- 実地が多い場合:
  ```
  Movement Type: 入荷
  Quantity: 差分
  Notes: 棚卸差異（プラス）
  ```

- 実地が少ない場合:
  ```
  Movement Type: 消費
  Quantity: 差分
  Notes: 棚卸差異（マイナス）
  ```

#### 3. 棚卸完了後

1. `Quantity` を `Physical Count` に合わせる
2. `Physical Count` をクリア
3. `Last Updated At` が更新される

### 棚卸しのベストプラクティス

- **頻度**: 月次または四半期ごと
- **タイミング**: 月末または月初
- **記録**: 棚卸表をExcelで管理
- **ダブルチェック**: 2名で確認

---

## トラブルシューティング

### Q1. 在庫がマイナスになった

**原因**:
- 消費を記録しすぎた
- 入荷を記録し忘れた

**解決方法**:
1. 在庫移動履歴を確認
2. 誤った記録を特定
3. Supply Movement を削除（該当の移動記録）
4. 必要に応じて正しい記録を再作成

### Q2. アラートが届かない

**確認事項**:
1. `reorder_point` が設定されているか
2. バッチ処理が実行されているか

**手動チェック**:
```bash
bin/rails supplies:check_stock
```

### Q3. 拠点間移動で在庫が更新されない

**確認事項**:
1. Movement Type が「移動」になっているか
2. From と To の両方が正しく設定されているか

**解決方法**:
- Supply Movement の詳細を確認
- 必要に応じて削除・再作成

### Q4. 総在庫数が合わない

**原因**:
- Supply Stocks の合計とシステム表示が異なる

**解決方法**:
```ruby
# Rails consoleで確認
supply = Supply.find_by(sku: 'CONT-L-001')
supply.total_stock  # システム計算
supply.supply_stocks.sum(:quantity)  # 直接集計

# 差異がある場合、Supply Stocks を確認
supply.supply_stocks.each do |stock|
  puts "#{stock.location_name}: #{stock.quantity}"
end
```

---

## ベストプラクティス

### 在庫管理のコツ

1. **こまめな記録**
   - 使用したらすぐに「消費」を記録
   - 入荷したらすぐに「入荷」を記録

2. **再注文ポイントの設定**
   - 過去の使用実績から適切な値を設定
   - 例: 月平均使用量 × 1.5倍

3. **定期棚卸**
   - 月次で主要備品を棚卸
   - システム在庫との差異を早期発見

4. **Notes の活用**
   - 在庫移動の理由を必ず記録
   - 後から追跡しやすくなる

### SKU命名規則（推奨）

```
カテゴリ-サイズ-連番

例:
CONT-L-001  : Container Large 001
CHOP-R-001  : Chopstick Regular 001
NKIN-S-001  : Napkin Small 001
```

---

## 関連ページ

- [データ移行手順書](../migration/phase2_data_migration.md)
- [システム構成ドキュメント](../architecture/phase2_system_architecture.md)

---

**更新履歴**:
- 2025-12-04: 初版作成
