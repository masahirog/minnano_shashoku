# 請求書管理操作マニュアル

**Phase 2: 請求・支払い管理システム**

---

## 目次

1. [概要](#概要)
2. [請求書の一括生成](#請求書の一括生成)
3. [請求書の確認・編集](#請求書の確認編集)
4. [請求書PDF出力](#請求書pdf出力)
5. [請求書のステータス管理](#請求書のステータス管理)
6. [トラブルシューティング](#トラブルシューティング)

---

## 概要

請求書管理機能では、企業ごとの月次請求書を自動生成し、PDF出力や送付、支払状況の管理ができます。

### 主な機能

- **自動生成**: 月次の注文データから請求書を一括生成
- **PDF出力**: 請求書をPDF形式で出力
- **ステータス管理**: 下書き → 送信済み → 支払済みの管理
- **支払管理**: 入金の記録と支払状況の追跡

---

## 請求書の一括生成

### 手順

1. **管理画面にアクセス**
   - ログイン後、左メニューから「Invoices」を選択

2. **一括生成画面を開く**
   - 画面上部の「一括生成」ボタンをクリック
   - または URL: `/admin/invoice_generations/new`

3. **生成条件の設定**
   ```
   対象年月: 2025年12月
   [生成する]ボタンをクリック
   ```

4. **生成結果の確認**
   - 成功メッセージが表示されます
   - 「○件の請求書を生成しました」
   - 生成された請求書一覧が表示されます

### 自動生成される内容

- **請求書番号**: `INV-YYYYMM-XXXX` 形式で自動採番
- **発行日**: 対象月の翌月1日
- **支払期限**: 発行日から30日後
- **請求明細**: 対象月の全注文データ
- **金額計算**: 小計 + 消費税(10%) = 合計金額

### 注意事項

- 既に請求書が存在する企業・月はスキップされます
- 対象月に注文がない企業は請求書が生成されません
- 生成後、下書き状態になります（status: 'draft'）

---

## 請求書の確認・編集

### 請求書一覧の確認

1. **一覧画面にアクセス**
   - 左メニュー「Invoices」をクリック

2. **表示内容**
   - 請求書番号
   - 企業名
   - 発行日
   - 合計金額
   - ステータス（下書き/送信済み/支払済み）
   - 支払ステータス（未払い/一部支払/支払済み/期限超過）

3. **検索・フィルター**
   - 検索ボックス: 請求書番号、企業名で検索
   - ステータスフィルター: ステータスで絞り込み

### 個別請求書の確認

1. **詳細画面を開く**
   - 一覧から請求書番号をクリック

2. **確認できる情報**
   - 基本情報（企業、発行日、支払期限）
   - 請求明細（注文ごとの内訳）
   - 金額（小計、消費税、合計）
   - 入金履歴（入金日、金額、支払方法）
   - ステータス

### 請求書の編集

1. **編集画面を開く**
   - 詳細画面の「Edit Invoice」ボタンをクリック

2. **編集可能な項目**
   - 発行日
   - 支払期限
   - 備考（Notes）
   - ステータス
   - 支払ステータス

3. **保存**
   - 「Update Invoice」ボタンをクリック

### 注意事項

- 請求書番号は変更できません
- 金額は明細から自動計算されるため直接編集できません
- 明細を変更したい場合は、InvoiceItemsから編集してください

---

## 請求書PDF出力

### PDF出力方法

1. **個別出力**
   - 請求書詳細画面を開く
   - 画面上部の「PDF表示」ボタンをクリック
   - または URL: `/admin/invoices/{id}/pdf`

2. **PDFの内容**
   - 企業情報（正式名称、請求先部署・担当者）
   - 請求書番号、発行日、支払期限
   - 請求明細（日付、内容、数量、単価、金額）
   - 小計、消費税、合計金額
   - 振込先情報
   - 備考

3. **印刷・保存**
   - ブラウザの印刷機能で印刷
   - PDFとして保存も可能

### メール送付

現在、メール送付機能は未実装です。
PDFをダウンロードして手動でメール添付してください。

**将来の実装予定**:
- PDFの自動メール送付機能
- 送付履歴の記録

---

## 請求書のステータス管理

### ステータスの種類

#### 1. Status（請求書ステータス）

| ステータス | 説明 | 次のアクション |
|------------|------|----------------|
| draft | 下書き | 内容確認後、送信済みに変更 |
| sent | 送信済み | 入金待ち |
| paid | 支払済み | （完了） |
| cancelled | キャンセル | - |

#### 2. Payment Status（支払ステータス）

| ステータス | 説明 | 表示条件 |
|------------|------|----------|
| unpaid | 未払い | 入金なし |
| partial | 一部支払 | 一部入金あり |
| paid | 支払済み | 全額入金済み |
| overdue | 期限超過 | 支払期限を過ぎても未払い |

### ステータスの変更方法

#### 手動変更

1. 請求書の編集画面を開く
2. Status または Payment Status を選択
3. 「Update Invoice」ボタンをクリック

#### 自動変更

以下の場合、自動的にステータスが変更されます：

- **入金登録時**: payment_status が自動更新
  - 全額入金 → 'paid'
  - 一部入金 → 'partial'
- **期限超過チェック**: 毎日自動実行
  - 支払期限を過ぎた未払い請求書 → 'overdue'

### 期限超過アラート

**自動チェック（未実装）**:
- 毎日深夜に自動実行
- 期限超過の請求書を検出
- 担当者にメール通知

**手動チェック**:
```bash
# 期限超過チェックを実行
bin/rails invoices:check_overdue
```

---

## トラブルシューティング

### Q1. 請求書が生成されない

**確認事項**:
1. 対象月に注文データがあるか確認
2. 企業の `contract_status` が 'active' か確認
3. 既に同じ月の請求書が存在していないか確認

**解決方法**:
- 注文データを確認: `/admin/orders` で対象月の注文を検索
- 企業情報を確認: `/admin/companies/{id}`

### Q2. PDF出力でエラーが発生する

**確認事項**:
1. 請求書に明細が存在するか
2. 企業情報（正式名称、請求先情報）が登録されているか

**解決方法**:
- 明細を追加: `/admin/invoice_items`
- 企業情報を補完: `/admin/companies/{id}/edit`

### Q3. 金額が合わない

**確認事項**:
1. 請求明細の内容を確認
2. 消費税率（10%）が正しく適用されているか

**解決方法**:
- 明細を修正後、以下のコマンドで再計算:
```ruby
# Rails consoleで実行
invoice = Invoice.find(請求書ID)
invoice.recalculate_amounts!
```

### Q4. ステータスが自動更新されない

**確認事項**:
1. 入金が正しく登録されているか
2. バッチ処理が実行されているか

**解決方法**:
- 入金履歴を確認: `/admin/payments`
- 手動でステータス更新:
```ruby
# Rails consoleで実行
invoice = Invoice.find(請求書ID)
invoice.update_payment_status
```

---

## 関連ページ

- [入金管理操作マニュアル](./payment_management.md)
- [支払状況レポート](./report_management.md)
- [データ移行手順書](../migration/phase2_data_migration.md)

---

**更新履歴**:
- 2025-12-04: 初版作成
