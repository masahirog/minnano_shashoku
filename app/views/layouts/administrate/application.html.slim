/
  Application Layout

  This view template is used as the layout
  for every page that Administrate generates.

doctype html
html lang=I18n.locale
  head
    meta charset="utf-8"
    meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"
    title
      = content_for(:title)
      |  - みんなの社食 管理画面
    = csrf_meta_tags
    - if defined?(csp_meta_tag)
      = csp_meta_tag

    / Bootstrap CSS
    link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
    / Font Awesome
    link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    / AdminLTE
    link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css"

    = render "administrate/application/stylesheet"
    = render "administrate/application/javascript"
    = javascript_importmap_tags

    css:
      /* AdminLTE Customizations */

      /* Reset Administrate default styles and apply AdminLTE */
      *:not(.fa):not(.fas):not(.far):not(.fab):not(.fal):not(.fad):not([class*="fa-"]) {
        font-family: 'Source Sans Pro', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif !important;
      }

      /* Ensure Font Awesome icons use correct font */
      .fa, .fas, .far, .fab, .fal, .fad, [class*="fa-"] {
        font-family: "Font Awesome 6 Free", "Font Awesome 6 Brands" !important;
      }

      /* Input group内のinputとbuttonの高さを揃える */
      .input-group-sm .form-control,
      .input-group-sm .btn {
        height: calc(1.5em + 0.5rem + 2px);
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
        line-height: 1.5;
        border-radius: 0.2rem;
      }

      /* Override Administrate button defaults */
      button:not(.btn),
      [type="button"]:not(.btn),
      [type="reset"]:not(.btn),
      [type="submit"]:not(.btn),
      .button:not(.btn) {
        background-color: transparent;
        border: 1px solid transparent;
        color: inherit;
        font-family: inherit;
        font-size: inherit;
        font-weight: normal;
        padding: 0;
      }

      /* Bootstrap buttons should take priority */
      .btn {
        font-family: 'Source Sans Pro', sans-serif !important;
        font-weight: 400;
        line-height: 1.5 !important;
      }

      .btn-primary {
        background-color: #007bff !important;
        border-color: #007bff !important;
        color: #fff !important;
      }

      .btn-primary:hover,
      .btn-primary:focus,
      .btn-primary:active {
        background-color: #0069d9 !important;
        border-color: #0062cc !important;
        color: #fff !important;
      }

      .btn-danger {
        background-color: #dc3545 !important;
        border-color: #dc3545 !important;
        color: #fff !important;
      }

      .btn-danger:hover,
      .btn-danger:focus,
      .btn-danger:active {
        background-color: #c82333 !important;
        border-color: #bd2130 !important;
        color: #fff !important;
      }

      .btn-success {
        background-color: #28a745 !important;
        border-color: #28a745 !important;
        color: #fff !important;
      }

      .btn-success:hover,
      .btn-success:focus,
      .btn-success:active {
        background-color: #218838 !important;
        border-color: #1e7e34 !important;
        color: #fff !important;
      }

      .btn-info {
        background-color: #17a2b8 !important;
        border-color: #17a2b8 !important;
        color: #fff !important;
      }

      .btn-info:hover,
      .btn-info:focus,
      .btn-info:active {
        background-color: #138496 !important;
        border-color: #117a8b !important;
        color: #fff !important;
      }

      .btn-warning {
        background-color: #ffc107 !important;
        border-color: #ffc107 !important;
        color: #212529 !important;
      }

      .btn-secondary {
        background-color: #6c757d !important;
        border-color: #6c757d !important;
        color: #fff !important;
      }

      .btn-link {
        background: transparent !important;
        border: none !important;
        box-shadow: none !important;
        color: #6c757d !important;
      }

      .btn-link:hover,
      .btn-link:focus,
      .btn-link:active {
        background: transparent !important;
        box-shadow: none !important;
        text-decoration: none !important;
        color: #343a40 !important;
      }

      .btn-sm {
        font-size: 0.875rem !important;
        padding: 0.375rem 0.75rem !important;
        line-height: 1.5 !important;
        height: auto !important;
      }

      /* submitボタンとlinkボタンの高さを統一 */
      input[type="submit"].btn-sm,
      button[type="submit"].btn-sm {
        height: calc(1.5em + 0.75rem + 2px) !important;
      }

      /* 検索ボックスの高さを35pxに統一 */
      input[type="search"],
      input[type="text"].form-control-sm,
      select.form-control-sm {
        height: 35px !important;
        box-sizing: border-box !important;
      }

      .search__label {
        height: 35px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
      }

      .search__eyeglass-icon {
        width: 1.125rem !important;
        height: 1.125rem !important;
      }

      /* AdminLTE Layout adjustments */
      .content-wrapper {
        background: #f4f6f9;
        min-height: 100vh;
        margin-left: 250px;
        transition: margin-left 0.3s ease-in-out;
        margin-top: 0;
      }

      body.sidebar-collapse .content-wrapper {
        margin-left: 4.6rem;
      }

      /* Brand link styling */
      .brand-link {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        padding: 15px !important;
      }

      .brand-link .brand-logo-link {
        color: inherit;
        text-decoration: none;
      }

      .brand-link .pushmenu-btn {
        color: rgba(255,255,255,.8);
        padding: 0;
        margin: 0;
        width: 30px;
        height: 30px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.3s ease;
      }

      .brand-link .pushmenu-btn:hover {
        background-color: rgba(255,255,255,0.1) !important;
        border-radius: 0.25rem;
        text-decoration: none;
      }

      /* User panel styling */
      .user-panel .user-icon {
        font-size: 32px;
        color: #fbbf24;
        line-height: 40px;
      }

      .user-panel .user-link {
        color: #fbbf24 !important;
      }

      .user-panel .user-link:hover {
        color: #ffffff !important;
      }

      /* サイドバーが閉じた時の調整 */
      body.sidebar-collapse .brand-link {
        justify-content: space-between;
      }

      /* メニューの青い背景を削除 */
      .sidebar-dark-primary .nav-sidebar > .nav-item > .nav-link.active {
        background-color: transparent !important;
        color: #c2c7d0 !important;
      }

      .sidebar-dark-primary .nav-sidebar > .nav-item.menu-open > .nav-link {
        background-color: transparent !important;
        color: #60a5fa !important;
      }

      /* サブメニューの青い背景も削除 */
      .sidebar-dark-primary .nav-treeview > .nav-item > .nav-link.active {
        background-color: rgba(255,255,255,.1) !important;
        color: #fff !important;
      }

      /* サブメニューの視認性改善 */
      .nav-treeview > .nav-item > .nav-link {
        padding-left: 2.5rem !important;
        font-size: 0.875rem;
      }

      /* 親メニュー（カテゴリ）の色を統一 */
      .nav-sidebar > .nav-item.has-treeview > .nav-link {
        color: #60a5fa !important;
        font-weight: 500;
      }

      .nav-sidebar > .nav-item.has-treeview > .nav-link:hover {
        color: #ffffff !important;
      }

  body.sidebar-mini.layout-fixed
    javascript:
      // Apply sidebar state immediately to prevent flash
      if (localStorage.getItem('sidebar-collapse') === 'true') {
        document.body.classList.add('sidebar-collapse');
      }

    / Sidebar
    = render "admin/application/navigation"

    / Main Content
    .content-wrapper
      / Flash Messages
      = render "admin/application/flashes"

      / Page Content
      = yield

    / jQuery (required by AdminLTE and custom scripts)
    script src="https://code.jquery.com/jquery-3.6.0.min.js"
    / Bootstrap 4 (required for modals and other components)
    script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"
    / AdminLTE
    script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"

    / Page-specific JavaScript
    = yield :javascript

    / Custom pushmenu script
    javascript:
      $(document).ready(function() {
        // ハンバーガーボタンのクリックイベント
        $('.pushmenu-btn').on('click', function(e) {
          e.preventDefault();
          $('body').toggleClass('sidebar-collapse');

          // 状態をlocalStorageに保存
          var isCollapsed = $('body').hasClass('sidebar-collapse');
          localStorage.setItem('sidebar-collapse', isCollapsed);
        });

        // メニューの開閉状態を保存・復元
        const MENU_STORAGE_KEY = 'sidebar-menu-state';

        // ページロード時に保存された状態を復元
        function restoreMenuState() {
          const savedState = localStorage.getItem(MENU_STORAGE_KEY);
          if (savedState) {
            try {
              const openMenus = JSON.parse(savedState);
              openMenus.forEach(function(menuId) {
                const menuItem = $('#' + menuId);
                if (menuItem.length && !menuItem.hasClass('menu-open')) {
                  menuItem.addClass('menu-open');
                  // サブメニューを表示状態にする
                  menuItem.find('> .nav-treeview').show();
                }
              });
            } catch (e) {
              console.error('Failed to restore menu state:', e);
            }
          }
        }

        // 現在開いているメニューを保存
        function saveMenuState() {
          const openMenus = [];
          $('.nav-item.has-treeview.menu-open').each(function() {
            const id = $(this).attr('id');
            if (id) {
              openMenus.push(id);
            }
          });
          localStorage.setItem(MENU_STORAGE_KEY, JSON.stringify(openMenus));
        }

        // 親メニュークリック時：AdminLTEのアニメーション完了を待ってから保存
        $('.nav-item.has-treeview > .nav-link').on('click', function(e) {
          // AdminLTEのアニメーション完了を待つ（400ms）
          setTimeout(function() {
            saveMenuState();
          }, 400);
        });

        // サブメニューのリンククリック時にも親メニューの状態を保存
        $('.nav-treeview .nav-link').on('click', function(e) {
          // すぐに保存（サブメニューはアニメーションなし）
          saveMenuState();
        });

        // 初期状態を復元
        restoreMenuState();
      });
