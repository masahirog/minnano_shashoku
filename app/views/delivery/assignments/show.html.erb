<div class="container mx-auto px-4 py-6 max-w-4xl">
  <!-- ヘッダー -->
  <div class="mb-6">
    <%= link_to delivery_assignments_path, class: "inline-flex items-center text-blue-600 hover:text-blue-800 mb-3" do %>
      <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
      </svg>
      戻る
    <% end %>
    <h1 class="text-2xl font-bold text-gray-800">配送詳細</h1>
  </div>

  <!-- ステータスバナー -->
  <div class="mb-6 p-4 rounded-lg <%=
    case @delivery_assignment.status
    when 'pending' then 'bg-gray-100 border border-gray-300'
    when 'preparing' then 'bg-yellow-100 border border-yellow-300'
    when 'in_transit' then 'bg-blue-100 border border-blue-300'
    when 'completed' then 'bg-green-100 border border-green-300'
    when 'failed' then 'bg-red-100 border border-red-300'
    end
  %>">
    <div class="flex items-center justify-between">
      <div class="flex items-center">
        <span class="text-2xl mr-3">
          <%=
            case @delivery_assignment.status
            when 'pending' then '⏸️'
            when 'preparing' then '📦'
            when 'in_transit' then '🚚'
            when 'completed' then '✅'
            when 'failed' then '❌'
            end
          %>
        </span>
        <div>
          <p class="text-sm text-gray-600">ステータス</p>
          <p class="text-lg font-bold <%=
            case @delivery_assignment.status
            when 'pending' then 'text-gray-800'
            when 'preparing' then 'text-yellow-800'
            when 'in_transit' then 'text-blue-800'
            when 'completed' then 'text-green-800'
            when 'failed' then 'text-red-800'
            end
          %>">
            <%=
              case @delivery_assignment.status
              when 'pending' then '待機中'
              when 'preparing' then '準備中'
              when 'in_transit' then '配送中'
              when 'completed' then '配送完了'
              when 'failed' then '配送失敗'
              end
            %>
          </p>
        </div>
      </div>

      <% if @delivery_assignment.assigned_at.present? %>
        <div class="text-right">
          <p class="text-xs text-gray-600">割当日時</p>
          <p class="text-sm font-semibold text-gray-700"><%= @delivery_assignment.assigned_at.strftime('%m/%d %H:%M') %></p>
        </div>
      <% end %>
    </div>
  </div>

  <!-- 配送先情報 -->
  <div class="bg-white rounded-lg shadow-md p-6 mb-6">
    <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
      <svg class="w-6 h-6 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
      </svg>
      配送先情報
    </h2>

    <div class="space-y-3">
      <div>
        <p class="text-sm text-gray-600">企業名</p>
        <p class="text-lg font-semibold text-gray-900"><%= @order.company.name %></p>
      </div>

      <% if @order.recipient_name.present? %>
        <div>
          <p class="text-sm text-gray-600">受取人</p>
          <p class="font-semibold text-gray-900"><%= @order.recipient_name %></p>
        </div>
      <% end %>

      <div>
        <p class="text-sm text-gray-600">配送先住所</p>
        <p class="font-semibold text-gray-900"><%= @order.delivery_address || @order.company.delivery_address %></p>
      </div>

      <% if @order.recipient_phone.present? %>
        <div>
          <p class="text-sm text-gray-600">連絡先</p>
          <p class="font-semibold text-gray-900">
            <a href="tel:<%= @order.recipient_phone %>" class="text-blue-600 hover:underline">
              <%= @order.recipient_phone %>
            </a>
          </p>
        </div>
      <% end %>

      <div class="flex items-center justify-between pt-3 border-t">
        <div>
          <p class="text-sm text-gray-600">配送予定日時</p>
          <p class="font-semibold text-gray-900">
            <%= l(@delivery_assignment.scheduled_date, format: :long) %>
            <% if @delivery_assignment.scheduled_time %>
              <%= @delivery_assignment.scheduled_time.strftime('%H:%M') %>
            <% end %>
          </p>
        </div>
        <% if @delivery_assignment.sequence_number.present? %>
          <div class="text-right">
            <p class="text-sm text-gray-600">順序</p>
            <p class="text-lg font-bold text-gray-900"><%= @delivery_assignment.sequence_number %></p>
          </div>
        <% end %>
      </div>

      <!-- ナビゲーション起動ボタン -->
      <% address = @order.delivery_address || @order.company.delivery_address %>
      <% if address.present? %>
        <div class="pt-3 border-t">
          <a href="https://www.google.com/maps/dir/?api=1&destination=<%= ERB::Util.url_encode(address) %>"
             target="_blank"
             class="block w-full bg-blue-600 text-white text-center py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors">
            <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path>
            </svg>
            Google Mapsで開く
          </a>
        </div>
      <% end %>
    </div>
  </div>

  <!-- 商品情報 -->
  <div class="bg-white rounded-lg shadow-md p-6 mb-6">
    <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
      <svg class="w-6 h-6 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
      </svg>
      商品情報
    </h2>

    <div class="space-y-3">
      <% if @order.restaurant.present? %>
        <div>
          <p class="text-sm text-gray-600">飲食店</p>
          <p class="font-semibold text-gray-900"><%= @order.restaurant.name %></p>
        </div>
      <% end %>

      <% if @order.menu.present? %>
        <div>
          <p class="text-sm text-gray-600">メニュー</p>
          <p class="font-semibold text-gray-900"><%= @order.menu.name %></p>
        </div>
      <% end %>

      <div>
        <p class="text-sm text-gray-600">食数</p>
        <p class="text-2xl font-bold text-gray-900">
          <%= @order.confirmed_meal_count || @order.default_meal_count %>食
        </p>
      </div>

      <% if @order.collection_time.present? %>
        <div>
          <p class="text-sm text-gray-600">回収時刻</p>
          <p class="font-semibold text-gray-900"><%= @order.collection_time.strftime('%H:%M') %></p>
        </div>
      <% end %>

      <% if @order.warehouse_pickup_time.present? %>
        <div>
          <p class="text-sm text-gray-600">倉庫集荷時刻</p>
          <p class="font-semibold text-gray-900"><%= @order.warehouse_pickup_time.strftime('%H:%M') %></p>
        </div>
      <% end %>
    </div>
  </div>

  <!-- 特記事項 -->
  <% if @order.delivery_notes.present? || @order.equipment_notes.present? %>
    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 mb-6">
      <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
        <svg class="w-6 h-6 mr-2 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
        </svg>
        特記事項
      </h2>

      <div class="space-y-3">
        <% if @order.delivery_notes.present? %>
          <div>
            <p class="text-sm text-yellow-800 font-semibold">配送メモ</p>
            <p class="text-gray-900 whitespace-pre-wrap"><%= @order.delivery_notes %></p>
          </div>
        <% end %>

        <% if @order.equipment_notes.present? %>
          <div>
            <p class="text-sm text-yellow-800 font-semibold">器材メモ</p>
            <p class="text-gray-900 whitespace-pre-wrap"><%= @order.equipment_notes %></p>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <!-- アクションボタン -->
  <div class="space-y-3 pb-6">
    <% case @delivery_assignment.status %>
    <% when 'pending' %>
      <%= button_to "📦 準備を開始する", update_status_delivery_assignment_path(@delivery_assignment),
          method: :patch,
          params: { status: 'preparing' },
          data: { confirm: '配送準備を開始しますか？' },
          class: "w-full bg-yellow-600 text-white py-4 rounded-lg font-bold text-lg hover:bg-yellow-700 transition-colors" %>

    <% when 'preparing' %>
      <%= button_to "🚚 配送を開始する", update_status_delivery_assignment_path(@delivery_assignment),
          method: :patch,
          params: { status: 'in_transit' },
          data: { confirm: '配送を開始しますか？' },
          class: "w-full bg-blue-600 text-white py-4 rounded-lg font-bold text-lg hover:bg-blue-700 transition-colors" %>

    <% when 'in_transit' %>
      <%= link_to "✅ 配送報告を作成", new_delivery_assignment_report_path(@delivery_assignment),
          class: "block w-full text-center bg-green-600 text-white py-4 rounded-lg font-bold text-lg hover:bg-green-700 transition-colors" %>

    <% when 'completed' %>
      <div class="text-center py-8">
        <svg class="w-16 h-16 mx-auto text-green-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <p class="text-lg font-bold text-gray-800">配送が完了しました</p>
        <p class="text-gray-600 mt-2">お疲れ様でした！</p>
      </div>

    <% when 'failed' %>
      <div class="text-center py-8">
        <svg class="w-16 h-16 mx-auto text-red-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <p class="text-lg font-bold text-gray-800">配送が失敗としてマークされています</p>
        <p class="text-gray-600 mt-2">管理者に連絡してください</p>
      </div>
    <% end %>
  </div>
</div>
