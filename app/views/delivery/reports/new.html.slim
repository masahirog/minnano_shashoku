.container.mx-auto.px-4.py-6.max-w-4xl
  / ãƒ˜ãƒƒãƒ€ãƒ¼
  .mb-6
    = link_to delivery_assignment_path(@delivery_assignment), class: "inline-flex items-center text-blue-600 hover:text-blue-800 mb-3" do
      svg.w-5.h-5.mr-1 fill="none" stroke="currentColor" viewBox="0 0 24 24"
        path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"
      | æˆ»ã‚‹
    h1.text-2xl.font-bold.text-gray-800 é…é€å ±å‘Š
    p.text-gray-600.mt-1 = @delivery_assignment.order.company.name

  = form_with model: @delivery_report, url: delivery_assignment_report_path(@delivery_assignment), local: true, multipart: true do |f|
    - if @delivery_report.errors.any?
      .bg-red-100.border.border-red-400.text-red-700.px-4.py-3.rounded.mb-6
        h3.font-bold.mb-2 ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ
        ul.list-disc.list-inside
          - @delivery_report.errors.full_messages.each do |message|
            li = message

    / å ±å‘Šã‚¿ã‚¤ãƒ—é¸æŠ
    .bg-white.rounded-lg.shadow-md.p-6.mb-6
      h2.text-lg.font-bold.text-gray-800.mb-4 å ±å‘Šå†…å®¹

      .space-y-3
        label.flex.items-center.p-4.border-2.rounded-lg.cursor-pointer.hover:bg-gray-50.transition-colors id="report-type-completed"
          = f.radio_button :report_type, 'completed', class: 'w-5 h-5 text-green-600', checked: true, onchange: 'toggleIssueFields(false)'
          .ml-3.flex-1
            span.text-lg.font-semibold.text-gray-900 âœ… é…é€å®Œäº†
            p.text-sm.text-gray-600 æ­£å¸¸ã«é…é€ãŒå®Œäº†ã—ã¾ã—ãŸ

        label.flex.items-center.p-4.border-2.rounded-lg.cursor-pointer.hover:bg-gray-50.transition-colors id="report-type-issue"
          = f.radio_button :report_type, 'issue', class: 'w-5 h-5 text-yellow-600', onchange: 'toggleIssueFields(true)'
          .ml-3.flex-1
            span.text-lg.font-semibold.text-gray-900 âš ï¸ å•é¡Œã‚ã‚Š
            p.text-sm.text-gray-600 é…é€ã«å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸ

        label.flex.items-center.p-4.border-2.rounded-lg.cursor-pointer.hover:bg-gray-50.transition-colors id="report-type-failed"
          = f.radio_button :report_type, 'failed', class: 'w-5 h-5 text-red-600', onchange: 'toggleIssueFields(true)'
          .ml-3.flex-1
            span.text-lg.font-semibold.text-gray-900 âŒ é…é€å¤±æ•—
            p.text-sm.text-gray-600 é…é€ã‚’å®Œäº†ã§ãã¾ã›ã‚“ã§ã—ãŸ

    / å•é¡Œç¨®åˆ¥ï¼ˆå•é¡Œå ±å‘Šæ™‚ã®ã¿è¡¨ç¤ºï¼‰
    .bg-white.rounded-lg.shadow-md.p-6.mb-6.hidden id="issue-fields"
      h2.text-lg.font-bold.text-gray-800.mb-4 å•é¡Œã®è©³ç´°

      .mb-4
        label.block.text-sm.font-medium.text-gray-700.mb-2 å•é¡Œç¨®åˆ¥
        select.w-full.px-4.py-3.border.border-gray-300.rounded-lg.focus:ring-2.focus:ring-blue-500.focus:border-transparent name="delivery_report[issue_type]"
          option value="" é¸æŠã—ã¦ãã ã•ã„
          option value="absent" ä¸åœ¨
          option value="address_unknown" ä½æ‰€ä¸æ˜
          option value="damaged" å•†å“ç ´æ
          option value="other" ãã®ä»–

    / å†™çœŸæ’®å½±
    .bg-white.rounded-lg.shadow-md.p-6.mb-6
      h2.text-lg.font-bold.text-gray-800.mb-4.flex.items-center
        svg.w-6.h-6.mr-2.text-blue-600 fill="none" stroke="currentColor" viewBox="0 0 24 24"
          path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"
          path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"
        | å†™çœŸã‚’æ’®å½±

      .mb-4
        label.block.w-full.bg-blue-600.text-white.text-center.py-4.rounded-lg.font-bold.text-lg.hover:bg-blue-700.transition-colors.cursor-pointer for="photo-input"
          svg.w-6.h-6.inline.mr-2 fill="none" stroke="currentColor" viewBox="0 0 24 24"
            path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"
          | å†™çœŸã‚’è¿½åŠ 
        = f.file_field :photos, multiple: true, accept: 'image/*', capture: 'environment', class: 'hidden', id: 'photo-input', onchange: 'previewPhotos(event)'

      / å†™çœŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
      #photo-previews.grid.grid-cols-2.gap-3
        / ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™

      p.text-sm.text-gray-600.mt-3
        | â„¹ï¸ è¤‡æ•°æšã®å†™çœŸã‚’æ’®å½±ã§ãã¾ã™ã€‚é…é€çŠ¶æ³ãŒã‚ã‹ã‚‹å†™çœŸã‚’æ’®å½±ã—ã¦ãã ã•ã„ã€‚

    / ä½ç½®æƒ…å ±
    .bg-white.rounded-lg.shadow-md.p-6.mb-6
      h2.text-lg.font-bold.text-gray-800.mb-4.flex.items-center
        svg.w-6.h-6.mr-2.text-green-600 fill="none" stroke="currentColor" viewBox="0 0 24 24"
          path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
          path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
        | ä½ç½®æƒ…å ±

      button.w-full.bg-green-600.text-white.py-4.rounded-lg.font-bold.text-lg.hover:bg-green-700.transition-colors.mb-3 type="button" onclick="getLocation()" id="location-button"
        svg.w-6.h-6.inline.mr-2 fill="none" stroke="currentColor" viewBox="0 0 24 24"
          path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
          path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
        | ç¾åœ¨åœ°ã‚’å–å¾—

      = f.hidden_field :latitude, id: 'latitude-field'
      = f.hidden_field :longitude, id: 'longitude-field'

      #location-status.text-sm.text-gray-600
        | ä½ç½®æƒ…å ±ã‚’å–å¾—ã—ã¦ã„ã¾ã›ã‚“

    / ãƒ¡ãƒ¢
    .bg-white.rounded-lg.shadow-md.p-6.mb-6
      h2.text-lg.font-bold.text-gray-800.mb-4 ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰
      = f.text_area :notes, rows: 4, class: 'w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent', placeholder: 'é…é€æ™‚ã®ç‰¹è¨˜äº‹é …ã‚„é€£çµ¡äº‹é …ãŒã‚ã‚Œã°å…¥åŠ›ã—ã¦ãã ã•ã„'

    / é€ä¿¡ãƒœã‚¿ãƒ³
    .space-y-3.pb-6
      = f.submit 'å ±å‘Šã‚’é€ä¿¡', class: 'w-full bg-blue-600 text-white py-4 rounded-lg font-bold text-lg hover:bg-blue-700 transition-colors'
      = link_to 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«', delivery_assignment_path(@delivery_assignment), class: 'block w-full text-center bg-gray-200 text-gray-800 py-4 rounded-lg font-bold text-lg hover:bg-gray-300 transition-colors'

javascript:
  // å•é¡Œç¨®åˆ¥ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¡¨ç¤º/éè¡¨ç¤º
  function toggleIssueFields(show) {
    const issueFields = document.getElementById('issue-fields');
    if (show) {
      issueFields.classList.remove('hidden');
    } else {
      issueFields.classList.add('hidden');
    }
  }

  // å†™çœŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
  function previewPhotos(event) {
    const files = event.target.files;
    const previewContainer = document.getElementById('photo-previews');

    Array.from(files).forEach(file => {
      const reader = new FileReader();
      reader.onload = function(e) {
        const div = document.createElement('div');
        div.className = 'relative';
        div.innerHTML = `
          <img src="${e.target.result}" class="w-full h-32 object-cover rounded-lg">
          <div class="absolute top-2 right-2 bg-white rounded-full p-1">
            <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
          </div>
        `;
        previewContainer.appendChild(div);
      };
      reader.readAsDataURL(file);
    });
  }

  // ä½ç½®æƒ…å ±å–å¾—
  function getLocation() {
    const button = document.getElementById('location-button');
    const status = document.getElementById('location-status');

    if (!navigator.geolocation) {
      status.innerHTML = '<span class="text-red-600">âš ï¸ ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“</span>';
      return;
    }

    button.disabled = true;
    button.innerHTML = '<span class="animate-pulse">ğŸ“ å–å¾—ä¸­...</span>';
    status.innerHTML = '<span class="text-blue-600">ä½ç½®æƒ…å ±ã‚’å–å¾—ã—ã¦ã„ã¾ã™...</span>';

    navigator.geolocation.getCurrentPosition(
      function(position) {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;
        const accuracy = position.coords.accuracy;

        document.getElementById('latitude-field').value = lat;
        document.getElementById('longitude-field').value = lng;

        button.disabled = false;
        button.innerHTML = `
          <svg class="w-6 h-6 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
          å–å¾—å®Œäº†
        `;
        button.classList.remove('bg-green-600', 'hover:bg-green-700');
        button.classList.add('bg-gray-500');

        status.innerHTML = `
          <span class="text-green-600">âœ… ä½ç½®æƒ…å ±ã‚’å–å¾—ã—ã¾ã—ãŸ</span><br>
          <span class="text-xs text-gray-600">ç·¯åº¦: ${lat.toFixed(6)}, çµŒåº¦: ${lng.toFixed(6)} (ç²¾åº¦: ${accuracy.toFixed(0)}m)</span>
        `;
      },
      function(error) {
        button.disabled = false;
        button.innerHTML = `
          <svg class="w-6 h-6 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
          </svg>
          å†å–å¾—
        `;

        let errorMsg = '';
        switch(error.code) {
          case error.PERMISSION_DENIED:
            errorMsg = 'âš ï¸ ä½ç½®æƒ…å ±ã®ä½¿ç”¨ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“';
            break;
          case error.POSITION_UNAVAILABLE:
            errorMsg = 'âš ï¸ ä½ç½®æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ';
            break;
          case error.TIMEOUT:
            errorMsg = 'âš ï¸ ä½ç½®æƒ…å ±ã®å–å¾—ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ';
            break;
          default:
            errorMsg = 'âš ï¸ ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ';
        }
        status.innerHTML = `<span class="text-red-600">${errorMsg}</span>`;
      },
      {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0
      }
    );
  }
