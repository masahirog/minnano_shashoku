<div class="content-wrapper">
  <!-- Content Header (Page header) -->
  <section class="content-header">
    <div class="container-fluid">
      <div class="row mb-2">
        <div class="col-sm-6">
          <h1>案件カレンダー</h1>
        </div>
        <div class="col-sm-6">
          <ol class="breadcrumb float-sm-right">
            <li class="breadcrumb-item"><%= link_to 'ホーム', admin_root_path %></li>
            <li class="breadcrumb-item"><%= link_to '案件', admin_orders_path %></li>
            <li class="breadcrumb-item active">カレンダー</li>
          </ol>
        </div>
      </div>
    </div>
  </section>

  <!-- Main content -->
  <section class="content">
    <div class="container-fluid">
      <!-- Filter Card -->
      <div class="card card-secondary collapsed-card">
        <div class="card-header">
          <h3 class="card-title">
            <i class="fas fa-filter mr-2"></i>
            フィルター
          </h3>
          <div class="card-tools">
            <button type="button" class="btn btn-tool" data-card-widget="collapse">
              <i class="fas fa-plus"></i>
            </button>
          </div>
        </div>
        <div class="card-body" style="display: none;">
          <%= form_with url: calendar_admin_orders_path, method: :get, local: true, class: "form-horizontal" do |f| %>
            <div class="row">
              <div class="col-md-4">
                <div class="form-group">
                  <%= f.label :company_id, '企業', class: 'control-label' %>
                  <%= f.select :company_id,
                      options_from_collection_for_select(Company.order(:name), :id, :name, params[:company_id]),
                      { include_blank: '全て' },
                      class: 'form-control' %>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-group">
                  <%= f.label :restaurant_id, '飲食店', class: 'control-label' %>
                  <%= f.select :restaurant_id,
                      options_from_collection_for_select(Restaurant.order(:name), :id, :name, params[:restaurant_id]),
                      { include_blank: '全て' },
                      class: 'form-control' %>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-group">
                  <%= f.label :status, 'ステータス', class: 'control-label' %>
                  <%= f.select :status,
                      options_for_select([['全て', ''], ['保留', 'pending'], ['確定', 'confirmed'], ['完了', 'completed'], ['キャンセル', 'cancelled']], params[:status]),
                      {},
                      class: 'form-control' %>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-12">
                <%= f.hidden_field :view, value: params[:view] %>
                <%= f.hidden_field :start_date, value: params[:start_date] %>
                <%= f.submit 'フィルター適用', class: 'btn btn-primary' %>
                <%= link_to 'リセット', calendar_admin_orders_path(view: params[:view], start_date: params[:start_date]), class: 'btn btn-default ml-2' %>
              </div>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Calendar Card -->
      <div class="card card-primary">
        <div class="card-header">
          <h3 class="card-title">
            <i class="far fa-calendar-alt mr-2"></i>
            <%= params[:view] == 'week' ? '週間表示' : '月間表示' %>
          </h3>
          <div class="card-tools">
            <% if params[:view] == 'week' %>
              <%= link_to '月間表示に切替', calendar_admin_orders_path(start_date: params[:start_date], view: 'month', company_id: params[:company_id], restaurant_id: params[:restaurant_id], status: params[:status]), class: 'btn btn-sm btn-secondary' %>
            <% else %>
              <%= link_to '週間表示に切替', calendar_admin_orders_path(start_date: params[:start_date], view: 'week', company_id: params[:company_id], restaurant_id: params[:restaurant_id], status: params[:status]), class: 'btn btn-sm btn-secondary' %>
            <% end %>
            <%= link_to '一覧に戻る', admin_orders_path, class: 'btn btn-sm btn-default ml-2' %>
          </div>
        </div>
        <div class="card-body p-0">
          <div class="calendar-container p-3">
            <% if params[:view] == 'week' %>
              <%= week_calendar(events: @orders, attribute: :scheduled_date, end_attribute: :scheduled_date) do |date, orders| %>
                <div class="calendar-day-header">
                  <%= date.strftime('%m/%d (%a)') %>
                </div>
                <div class="calendar-events">
                  <% orders.each do |order| %>
                    <div class="calendar-event"
                         data-order-id="<%= order.id %>"
                         style="background-color: <%= order.company&.color || '#2196f3' %>20; border-left-color: <%= order.company&.color || '#2196f3' %>;"
                         data-toggle="tooltip"
                         data-html="true"
                         title="<strong><%= order.company&.name %></strong><br>
                                <%= order.restaurant&.name %><br>
                                <% if order.menu %>メニュー: <%= order.menu.name %><br><% end %>
                                食数: <%= order.default_meal_count %>食<br>
                                ステータス: <%= order.status %>">
                      <%= link_to admin_order_path(order), class: 'calendar-event-link' do %>
                        <div class="event-time">
                          <%= order.delivery_time&.strftime('%H:%M') %>
                        </div>
                        <div class="event-company">
                          <%= order.company&.name %>
                        </div>
                        <div class="event-restaurant">
                          <%= order.restaurant&.name %>
                        </div>
                        <% if order.menu %>
                          <div class="event-menu text-muted small">
                            <%= order.menu.name %>
                          </div>
                        <% end %>
                      <% end %>
                    </div>
                  <% end %>
                </div>
              <% end %>
            <% else %>
              <%= month_calendar(events: @orders, attribute: :scheduled_date, end_attribute: :scheduled_date) do |date, orders| %>
                <div class="calendar-day-header">
                  <%= date.day %>
                </div>
                <div class="calendar-events">
                  <% orders.each do |order| %>
                    <div class="calendar-event calendar-event-small"
                         data-order-id="<%= order.id %>"
                         style="background-color: <%= order.company&.color || '#2196f3' %>20; border-left-color: <%= order.company&.color || '#2196f3' %>;"
                         data-toggle="tooltip"
                         data-html="true"
                         title="<strong><%= order.company&.name %></strong><br>
                                <%= order.restaurant&.name %><br>
                                <% if order.menu %>メニュー: <%= order.menu.name %><br><% end %>
                                食数: <%= order.default_meal_count %>食<br>
                                ステータス: <%= order.status %>">
                      <%= link_to admin_order_path(order), class: 'calendar-event-link' do %>
                        <div class="event-time small">
                          <%= order.delivery_time&.strftime('%H:%M') %>
                        </div>
                        <div class="event-company small">
                          <%= truncate(order.company&.name, length: 15) %>
                        </div>
                      <% end %>
                    </div>
                  <% end %>
                </div>
              <% end %>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<style>
.calendar-container {
  min-height: 600px;
}

.simple-calendar {
  border: 1px solid #dee2e6;
}

.simple-calendar .day {
  height: 120px;
  border: 1px solid #dee2e6;
  vertical-align: top;
  padding: 5px;
  background-color: #fff;
}

.simple-calendar .wday-0 .calendar-day-header {
  color: #e74c3c;
}

.simple-calendar .wday-6 .calendar-day-header {
  color: #3498db;
}

.simple-calendar .today {
  background-color: #fff3cd;
}

.simple-calendar .prev-month,
.simple-calendar .next-month {
  background-color: #f8f9fa;
  color: #6c757d;
}

.calendar-day-header {
  font-weight: bold;
  margin-bottom: 5px;
  font-size: 14px;
}

.calendar-events {
  max-height: 100px;
  overflow-y: auto;
}

.calendar-event {
  background-color: #e3f2fd;
  border-left: 3px solid #2196f3;
  padding: 4px 6px;
  margin-bottom: 3px;
  border-radius: 3px;
  font-size: 12px;
}

.calendar-event:hover {
  background-color: #bbdefb;
}

.calendar-event-link {
  color: inherit;
  text-decoration: none;
}

.calendar-event-link:hover {
  color: inherit;
  text-decoration: none;
}

.calendar-event-small {
  font-size: 11px;
  padding: 2px 4px;
}

.event-time {
  font-weight: bold;
  color: #1976d2;
}

.event-company {
  font-weight: 600;
}

.event-restaurant {
  color: #666;
}

.event-menu {
  font-style: italic;
}

.simple-calendar .calendar-heading {
  background-color: #343a40;
  color: #fff;
  padding: 10px;
  text-align: center;
  font-size: 18px;
  font-weight: bold;
}

.simple-calendar .calendar-heading a {
  color: #fff;
  text-decoration: none;
}

.simple-calendar .calendar-heading a:hover {
  color: #adb5bd;
}

.simple-calendar thead th {
  background-color: #6c757d;
  color: #fff;
  text-align: center;
  padding: 10px;
  font-weight: bold;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Initialize Bootstrap tooltips
  $('[data-toggle="tooltip"]').tooltip({
    placement: 'top',
    boundary: 'window'
  });
});
</script>
