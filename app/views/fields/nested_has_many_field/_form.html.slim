- available_menus = f.object.restaurant_id ? Menu.where(restaurant_id: f.object.restaurant_id).includes(:restaurant).order(:name) : Menu.includes(:restaurant).order(:name)
- all_menus_json = Menu.includes(:restaurant).order(:name).map { |m| { id: m.id, name: m.name, restaurant_id: m.restaurant_id, restaurant_name: m.restaurant&.name, price: m.price_per_meal, tax_rate: m.tax_rate } }.to_json

.field-unit.field-unit--nested-has-many.col-md-12
  .field-unit__label.col-md-2 style='margin:0;'
    = f.label field.attribute
  .field-unit__field.col-md-10 style='margin: 0;'
    div data-controller="nested-order-items" data-nested-order-items-restaurant-id="#{f.object.restaurant_id}" data-all-menus="#{all_menus_json}" style="overflow: hidden;"
      div data-nested-order-items-target="container"
        = f.fields_for field.attribute do |ff|
          .nested-item.mb-3.py-3.px-3.border.rounded data-nested-order-items-target="item" style="background-color: #f8f9fa; max-width: 100%; overflow: hidden; box-sizing: border-box;"
            .row.align-items-end
              .col-md-3
                = ff.label :menu_id, "ãƒ¡ãƒ‹ãƒ¥ãƒ¼", class: "form-label small mb-1"
                select.form-control.form-control-sm name="#{f.object_name}[#{field.attribute}_attributes][#{ff.index}][menu_id]" id="#{f.object_name}_#{field.attribute}_attributes_#{ff.index}_menu_id" data-nested-order-items-target="menuSelect" data-action="change->nested-order-items#updatePrice"
                  option value="" ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é¸æŠ
                  - available_menus.each do |menu|
                    option value="#{menu.id}" data-price="#{menu.price_per_meal}" data-tax-rate="#{menu.tax_rate}" selected=('selected' if ff.object.menu_id == menu.id)
                      = menu.name
                      - if !f.object.restaurant_id
                        =< "- #{menu.restaurant&.name}"
              .col-md-1
                = ff.label :tax_rate, "ç¨ç‡", class: "form-label small mb-1"
                = ff.number_field :tax_rate, class: "form-control form-control-sm bg-secondary-subtle text-center", readonly: true, data: { nested_order_items_target: "taxRate" }
              .col-md-1
                = ff.label :quantity, "æ•°é‡", class: "form-label small mb-1"
                = ff.number_field :quantity, class: "form-control form-control-sm", min: 0, value: ff.object.quantity || 0, data: { nested_order_items_target: "quantity", action: "input->nested-order-items#calculateSubtotal" }
              .col-md-1
                = ff.label :unit_price, "å˜ä¾¡", class: "form-label small mb-1"
                = ff.number_field :unit_price, class: "form-control form-control-sm bg-secondary-subtle", readonly: true, data: { nested_order_items_target: "unitPrice" }
              .col-md-2
                = ff.label :discount_type, "å‰²å¼•ç¨®åˆ¥", class: "form-label small mb-1"
                = ff.select :discount_type, options_for_select([["å‰²å¼•ãªã—", ""], ["%å¼•ã", "percentage"], ["å††å¼•ã", "fixed_amount"]], ff.object.discount_type), {}, class: "form-control form-control-sm", data: { nested_order_items_target: "discountType", action: "change->nested-order-items#calculateSubtotal" }
              .col-md-1
                = ff.label :discount_value, "å‰²å¼•å€¤", class: "form-label small mb-1"
                = ff.number_field :discount_value, class: "form-control form-control-sm", min: 0, value: ff.object.discount_value || 0, data: { nested_order_items_target: "discountValue", action: "input->nested-order-items#calculateSubtotal" }
              .col-md-2
                = ff.label :subtotal, "å°è¨ˆ", class: "form-label small mb-1"
                input.form-control.form-control-sm.bg-secondary-subtle type="number" readonly="" data-nested-order-items-target="subtotalDisplay" value="#{ff.object.subtotal || 0}"
                = ff.hidden_field :subtotal, data: { nested_order_items_target: "subtotal" }
                = ff.hidden_field :discount_amount, value: ff.object.discount_amount || 0, data: { nested_order_items_target: "discountAmount" }
              .col-md-1.text-center
                = ff.label :_destroy, "å‰Šé™¤", class: "form-label small mb-1 d-block"
                = ff.hidden_field :_destroy, value: '0'
                button.btn.btn-danger.btn-sm type="button" data-action="click->nested-order-items#removeItem" style="width: 40px; height: 31px;" Ã—

      button.btn.btn-secondary.btn-sm.mt-2 type="button" id="add-order-item-btn"
        | + ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¿½åŠ 

      template data-nested-order-items-target="template"
        .nested-item.mb-3.py-3.px-3.border.rounded data-nested-order-items-target="item" style="background-color: #f8f9fa; max-width: 100%; overflow: hidden; box-sizing: border-box;"
          .row.align-items-end
            .col-md-3
              label.form-label.small.mb-1 ãƒ¡ãƒ‹ãƒ¥ãƒ¼
              select.form-control.form-control-sm name="#{f.object_name}[#{field.attribute}_attributes][NEW_RECORD][menu_id]" data-nested-order-items-target="menuSelect"
                option value="" ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é¸æŠ
            .col-md-1
              label.form-label.small.mb-1 ç¨ç‡
              input.form-control.form-control-sm.bg-secondary-subtle.text-center type="number" name="#{f.object_name}[#{field.attribute}_attributes][NEW_RECORD][tax_rate]" readonly="" data-nested-order-items-target="taxRate" value=""
            .col-md-1
              label.form-label.small.mb-1 æ•°é‡
              input.form-control.form-control-sm type="number" name="#{f.object_name}[#{field.attribute}_attributes][NEW_RECORD][quantity]" min="0" value="0" data-nested-order-items-target="quantity" data-action="input->nested-order-items#calculateSubtotal"
            .col-md-1
              label.form-label.small.mb-1 å˜ä¾¡
              input.form-control.form-control-sm.bg-secondary-subtle type="number" name="#{f.object_name}[#{field.attribute}_attributes][NEW_RECORD][unit_price]" readonly="" data-nested-order-items-target="unitPrice"
            .col-md-2
              label.form-label.small.mb-1 å‰²å¼•ç¨®åˆ¥
              select.form-control.form-control-sm name="#{f.object_name}[#{field.attribute}_attributes][NEW_RECORD][discount_type]" data-nested-order-items-target="discountType" data-action="change->nested-order-items#calculateSubtotal"
                option value="" å‰²å¼•ãªã—
                option value="percentage" %å¼•ã
                option value="fixed_amount" å††å¼•ã
            .col-md-1
              label.form-label.small.mb-1 å‰²å¼•å€¤
              input.form-control.form-control-sm type="number" name="#{f.object_name}[#{field.attribute}_attributes][NEW_RECORD][discount_value]" min="0" value="0" data-nested-order-items-target="discountValue" data-action="input->nested-order-items#calculateSubtotal"
            .col-md-2
              label.form-label.small.mb-1 å°è¨ˆ
              input.form-control.form-control-sm.bg-secondary-subtle type="number" readonly="" data-nested-order-items-target="subtotalDisplay" value="0"
              input type="hidden" name="#{f.object_name}[#{field.attribute}_attributes][NEW_RECORD][subtotal]" data-nested-order-items-target="subtotal" value="0"
              input type="hidden" name="#{f.object_name}[#{field.attribute}_attributes][NEW_RECORD][discount_amount]" value="0" data-nested-order-items-target="discountAmount"
            .col-md-1.text-center
              label.form-label.small.mb-1.d-block å‰Šé™¤
              button.btn.btn-danger.btn-sm type="button" data-action="click->nested-order-items#removeItem" style="width: 40px; height: 31px;" Ã—

      javascript:
        (function() {
          const wrapper = document.querySelector('[data-controller="nested-order-items"]');
          const container = document.querySelector('[data-nested-order-items-target="container"]');
          const template = document.querySelector('[data-nested-order-items-target="template"]');
          const addBtn = document.getElementById('add-order-item-btn');

          if (!container || !template || !addBtn || !wrapper) {
            console.error('âŒ å¿…è¦ãªè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', {container, template, addBtn, wrapper});
            return;
          }

          // å…¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
          const allMenus = JSON.parse(wrapper.getAttribute('data-all-menus') || '[]');

          // ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ›´æ–°å‡¦ç†
          function updateMenuSelects(newRestaurantId) {
            // æ—¢å­˜ã®å…¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼selectã‚’æ›´æ–°
            const menuSelects = container.querySelectorAll('[data-nested-order-items-target="menuSelect"]');

            menuSelects.forEach(select => {
              // selectã‚’åˆæœŸåŒ–
              select.innerHTML = '<option value="">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é¸æŠ</option>';

              // æ–°ã—ã„ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ 
              if (newRestaurantId) {
                // å‹å¤‰æ›ã—ã¦æ¯”è¼ƒï¼ˆæ–‡å­—åˆ—ã¨æ•°å€¤ã®ä¸¡æ–¹ã«å¯¾å¿œï¼‰
                const filteredMenus = allMenus.filter(m => String(m.restaurant_id) === String(newRestaurantId));

                filteredMenus.forEach(menu => {
                  const option = document.createElement('option');
                  option.value = menu.id;
                  option.setAttribute('data-price', menu.price);
                  option.setAttribute('data-tax-rate', menu.tax_rate);
                  option.textContent = menu.name;
                  select.appendChild(option);
                });
              }

              // å˜ä¾¡ã¨å°è¨ˆã‚‚ã‚¯ãƒªã‚¢
              const item = select.closest('[data-nested-order-items-target="item"]');
              if (item) {
                const unitPriceInput = item.querySelector('[data-nested-order-items-target="unitPrice"]');
                const subtotalInput = item.querySelector('[data-nested-order-items-target="subtotal"]');
                if (unitPriceInput) unitPriceInput.value = '';
                if (subtotalInput) subtotalInput.value = '';
              }
            });
          }

          // Selectizeã®åˆæœŸåŒ–ã‚’å¾…ã£ã¦ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
          function setupSelectizeListener() {
            const restaurantSelectElement = document.querySelector('select[name*="[restaurant_id]"]');

            if (restaurantSelectElement && restaurantSelectElement.selectize) {
              const selectizeInstance = restaurantSelectElement.selectize;
              selectizeInstance.on('change', updateMenuSelects);
              return true;
            }
            return false;
          }

          // åˆæœŸåŒ–ã‚’è©¦è¡Œï¼ˆæœ€å¤§10å›ã€100msã”ã¨ï¼‰
          let attempts = 0;
          const maxAttempts = 10;
          const checkInterval = setInterval(function() {
            attempts++;

            if (setupSelectizeListener()) {
              clearInterval(checkInterval);
            } else if (attempts >= maxAttempts) {
              console.error('âŒ Selectizeã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼‰');
              clearInterval(checkInterval);
            }
          }, 100);

          // ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¿½åŠ 
          addBtn.addEventListener('click', function(e) {
            e.preventDefault();

            // ãã®æ™‚ç‚¹ã§ã®ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³selectã‚’å–å¾—
            const restaurantSelect = document.querySelector('select[name*="[restaurant_id]"]');
            const currentRestaurantId = restaurantSelect ? restaurantSelect.value : null;

            const timestamp = new Date().getTime();
            let content = template.innerHTML.replace(/NEW_RECORD/g, timestamp);

            // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’è¿½åŠ 
            container.insertAdjacentHTML('beforeend', content);
            const newItem = container.lastElementChild;

            // æ–°ã—ãè¿½åŠ ã•ã‚ŒãŸãƒ¡ãƒ‹ãƒ¥ãƒ¼selectã«optionã‚’å‹•çš„ã«è¿½åŠ 
            const newMenuSelect = newItem.querySelector('[data-nested-order-items-target="menuSelect"]');
            if (newMenuSelect) {
              // ç©ºã®optionã‹ã‚‰å§‹ã‚ã‚‹
              newMenuSelect.innerHTML = '<option value="">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é¸æŠ</option>';

              // ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã€ãã®ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã¿è¿½åŠ 
              if (currentRestaurantId) {
                // å‹å¤‰æ›ã—ã¦æ¯”è¼ƒï¼ˆæ–‡å­—åˆ—ã¨æ•°å€¤ã®ä¸¡æ–¹ã«å¯¾å¿œï¼‰
                const filteredMenus = allMenus.filter(m => String(m.restaurant_id) === String(currentRestaurantId));

                filteredMenus.forEach(menu => {
                  const option = document.createElement('option');
                  option.value = menu.id;
                  option.setAttribute('data-price', menu.price);
                  option.setAttribute('data-tax-rate', menu.tax_rate);
                  option.textContent = menu.name;
                  newMenuSelect.appendChild(option);
                });
              }
            }

            // æ–°ã—ãè¿½åŠ ã•ã‚ŒãŸè¦ç´ ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            setupItemEvents(newItem);
          });

          // æ—¢å­˜ã®ã‚¢ã‚¤ãƒ†ãƒ ã«ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
          document.querySelectorAll('[data-nested-order-items-target="item"]').forEach(setupItemEvents);

          function setupItemEvents(item) {
            const menuSelect = item.querySelector('[data-nested-order-items-target="menuSelect"]');
            const quantityInput = item.querySelector('[data-nested-order-items-target="quantity"]');
            const unitPriceInput = item.querySelector('[data-nested-order-items-target="unitPrice"]');
            const discountTypeSelect = item.querySelector('[data-nested-order-items-target="discountType"]');
            const discountValueInput = item.querySelector('[data-nested-order-items-target="discountValue"]');
            const discountAmountInput = item.querySelector('[data-nested-order-items-target="discountAmount"]');
            const subtotalInput = item.querySelector('[data-nested-order-items-target="subtotal"]');
            const subtotalDisplay = item.querySelector('[data-nested-order-items-target="subtotalDisplay"]');
            const destroyCheckbox = item.querySelector('input[name$="[_destroy]"]');
            const removeBtn = item.querySelector('.btn-danger');

            // ãƒ¡ãƒ‹ãƒ¥ãƒ¼é¸æŠæ™‚ã«å˜ä¾¡ã¨ç¨ç‡ã‚’æ›´æ–°
            if (menuSelect) {
              menuSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const price = selectedOption.getAttribute('data-price');
                const taxRate = selectedOption.getAttribute('data-tax-rate');

                if (unitPriceInput && price) {
                  unitPriceInput.value = price;
                }

                // ç¨ç‡ã‚’æ›´æ–°
                const taxRateInput = item.querySelector('[data-nested-order-items-target="taxRate"]');
                if (taxRateInput) {
                  taxRateInput.value = taxRate || '';
                }

                calculateSubtotal();
              });
            }

            // æ•°é‡å¤‰æ›´æ™‚ã«å°è¨ˆã‚’è¨ˆç®—
            if (quantityInput) {
              quantityInput.addEventListener('input', calculateSubtotal);
            }

            // å‰²å¼•ç¨®åˆ¥å¤‰æ›´æ™‚ã«å°è¨ˆã‚’å†è¨ˆç®—
            if (discountTypeSelect) {
              discountTypeSelect.addEventListener('change', function() {
                // å‰²å¼•ãªã—ã®å ´åˆã€å‰²å¼•å€¤ã‚’ç©ºã«ã™ã‚‹
                if (this.value === '' && discountValueInput) {
                  discountValueInput.value = '';
                }
                calculateSubtotal();
              });
            }

            // å‰²å¼•å€¤å¤‰æ›´æ™‚ã«å°è¨ˆã‚’å†è¨ˆç®—
            if (discountValueInput) {
              discountValueInput.addEventListener('input', calculateSubtotal);
            }

            // å‰Šé™¤ãƒœã‚¿ãƒ³
            if (removeBtn) {
              removeBtn.addEventListener('click', function(e) {
                e.preventDefault();
                if (destroyCheckbox) {
                  // æ—¢å­˜ãƒ¬ã‚³ãƒ¼ãƒ‰ã®å ´åˆã¯_destroyãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã¦éè¡¨ç¤º
                  destroyCheckbox.value = '1';
                  item.style.display = 'none';
                  // åˆè¨ˆã‚’å†è¨ˆç®—
                  calculateOrderTotals();
                } else {
                  // æ–°è¦ãƒ¬ã‚³ãƒ¼ãƒ‰ã®å ´åˆã¯å‰Šé™¤
                  item.remove();
                  // åˆè¨ˆã‚’å†è¨ˆç®—
                  calculateOrderTotals();
                }
              });
            }

            function calculateSubtotal() {
              const quantity = parseFloat(quantityInput.value) || 0;
              const unitPrice = parseFloat(unitPriceInput.value) || 0;
              const discountType = discountTypeSelect ? discountTypeSelect.value : '';
              const discountValue = parseFloat(discountValueInput?.value) || 0;

              // å‰²å¼•å¾Œã®å˜ä¾¡ã‚’è¨ˆç®—
              let discountedUnitPrice = unitPrice;
              if (discountType === 'percentage') {
                // %å¼•ã: å˜ä¾¡ Ã— (100 - å‰²å¼•ç‡) / 100
                discountedUnitPrice = unitPrice * (100 - discountValue) / 100;
              } else if (discountType === 'fixed_amount') {
                // å††å¼•ã: å˜ä¾¡ - å‰²å¼•é¡
                discountedUnitPrice = unitPrice - discountValue;
              }

              // å°è¨ˆ = æ•°é‡ Ã— å‰²å¼•å¾Œå˜ä¾¡ï¼ˆæ•´æ•°ã«ä¸¸ã‚ã‚‹ï¼‰
              const subtotal = Math.round(quantity * discountedUnitPrice);

              // å‰²å¼•é¡ = (å…ƒã®å˜ä¾¡ - å‰²å¼•å¾Œå˜ä¾¡) Ã— æ•°é‡ï¼ˆæ•´æ•°ã«ä¸¸ã‚ã‚‹ï¼‰
              const discountAmount = Math.round((unitPrice - discountedUnitPrice) * quantity);

              console.log('ğŸ§® å‰²å¼•è¨ˆç®—:', {
                quantity, unitPrice,
                discountType, discountValue,
                å‰²å¼•å¾Œå˜ä¾¡: discountedUnitPrice,
                å‰²å¼•é¡åˆè¨ˆ: discountAmount,
                å°è¨ˆ: subtotal
              });

              // hidden fieldã«è¨­å®š
              if (subtotalInput) {
                subtotalInput.value = subtotal;
              }

              // è¡¨ç¤ºç”¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«è¨­å®š
              if (subtotalDisplay) {
                subtotalDisplay.value = subtotal;
                console.log('âœ… subtotalè¡¨ç¤ºæ›´æ–°:', subtotal);
              } else {
                console.error('âŒ subtotalDisplay ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
              }

              // å‰²å¼•é¡ã‚’hidden fieldã«è¨­å®š
              if (discountAmountInput) {
                discountAmountInput.value = discountAmount;
                console.log('âœ… discount_amountè¨­å®š:', discountAmount);
              } else {
                console.error('âŒ discountAmountInput ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
              }

              // Orderå…¨ä½“ã®é‡‘é¡ã‚’å†è¨ˆç®—
              calculateOrderTotals();
            }
          }

          // Orderå…¨ä½“ã®é‡‘é¡ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°
          function calculateOrderTotals() {
            // å…¨ã¦ã®order_itemsã®å°è¨ˆã‚’å–å¾—
            const allSubtotalInputs = container.querySelectorAll('[data-nested-order-items-target="subtotal"]');
            let orderSubtotal = 0;
            let subtotal8 = 0;  // 8%å¯¾è±¡ã®å°è¨ˆ
            let subtotal10 = 0; // 10%å¯¾è±¡ã®å°è¨ˆ

            console.log('ğŸ’° calculateOrderTotalså®Ÿè¡Œé–‹å§‹');

            allSubtotalInputs.forEach((subtotalInput, index) => {
              const item = subtotalInput.closest('[data-nested-order-items-target="item"]');
              if (!item) return;

              // å‰Šé™¤ãƒã‚§ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
              const destroyCheckbox = item.querySelector('input[name$="[_destroy]"]');
              if (destroyCheckbox && destroyCheckbox.value === '1') return;

              const subtotal = parseFloat(subtotalInput.value) || 0;
              console.log(`ğŸ“ Item ${index}: subtotalèª­å– = ${subtotal}, name = ${subtotalInput.name}`);
              orderSubtotal += subtotal;

              // ç¨ç‡ã‚’å–å¾—ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯8%ï¼‰
              const taxRateSelect = item.querySelector('[data-nested-order-items-target="taxRate"]');
              const taxRate = taxRateSelect ? parseFloat(taxRateSelect.value) : 8;

              if (taxRate === 8) {
                subtotal8 += subtotal;
              } else {
                subtotal10 += subtotal;
              }
            });

            // æ¶ˆè²»ç¨ã‚’è¨ˆç®—
            const tax8 = Math.round(subtotal8 * 0.08);
            const tax10 = Math.round(subtotal10 * 0.10);
            const totalTax = tax8 + tax10;

            // é…é€æ–™ã‚’å–å¾—
            const deliveryFeeInput = document.querySelector('input[name="order[delivery_fee]"]');
            const deliveryFee = deliveryFeeInput ? Math.round(parseFloat(deliveryFeeInput.value) || 0) : 0;
            const deliveryFeeTax = Math.round(deliveryFee * 0.10);

            // æ¡ˆä»¶å‰²å¼•ã‚’å–å¾—
            const discountAmountInput = document.querySelector('input[name="order[discount_amount]"]');
            const discountAmount = discountAmountInput ? Math.round(parseFloat(discountAmountInput.value) || 0) : 0;

            // åˆè¨ˆé‡‘é¡ã‚’è¨ˆç®—ï¼ˆæ¡ˆä»¶ãƒ¬ãƒ™ãƒ«ã®å‰²å¼•ã‚’åæ˜ ï¼‰
            const totalPrice = Math.round(orderSubtotal + totalTax + deliveryFee + deliveryFeeTax - discountAmount);

            // å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ›´æ–°
            updateReadonlyField('order[subtotal]', orderSubtotal);
            updateReadonlyField('order[tax_8_percent]', tax8);
            updateReadonlyField('order[tax_10_percent]', tax10);
            updateReadonlyField('order[tax]', totalTax);
            updateReadonlyField('order[delivery_fee_tax]', deliveryFeeTax);
            updateReadonlyField('order[total_price]', totalPrice);

            // å°è¨ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆå•†å“å°è¨ˆ + é…é€æ–™ï¼‰ã‚‚æ›´æ–°
            const calculatedSubtotal = orderSubtotal + deliveryFee;
            updateFieldById('calculated_subtotal', calculatedSubtotal);

            // 10%ç¨åˆè¨ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆå•†å“ã®10% + é…é€æ–™ã®ç¨ï¼‰ã‚‚æ›´æ–°
            const tax10Total = tax10 + deliveryFeeTax;
            updateFieldById('calculated_tax_10_total', tax10Total);
          }

          // Readonlyãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ›´æ–°
          function updateReadonlyField(name, value) {
            const input = document.querySelector('input[name="' + name + '"]');
            if (input) {
              input.value = value;
            }
          }

          // IDã§ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ›´æ–°
          function updateFieldById(id, value) {
            const input = document.getElementById(id);
            if (input) {
              input.value = value;
            }
          }

          // é…é€æ–™ã¨æ¡ˆä»¶å‰²å¼•ã®å¤‰æ›´ã‚’ç›£è¦–ï¼ˆè¦ç´ ãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹ã¾ã§å¾…æ©Ÿï¼‰
          function setupOrderFieldListeners() {
            const deliveryFeeInput = document.querySelector('input[name="order[delivery_fee]"]');
            const discountAmountInput = document.querySelector('input[name="order[discount_amount]"]');

            if (deliveryFeeInput) {
              deliveryFeeInput.addEventListener('input', calculateOrderTotals);
              deliveryFeeInput.addEventListener('change', calculateOrderTotals);
            }

            if (discountAmountInput) {
              discountAmountInput.addEventListener('input', calculateOrderTotals);
              discountAmountInput.addEventListener('change', calculateOrderTotals);
            }

            return deliveryFeeInput;
          }

          // åˆæœŸåŒ–ã‚’è©¦è¡Œï¼ˆæœ€å¤§20å›ã€200msã”ã¨ï¼‰
          let orderFieldAttempts = 0;
          const maxOrderFieldAttempts = 20;
          const orderFieldCheckInterval = setInterval(function() {
            orderFieldAttempts++;

            if (setupOrderFieldListeners()) {
              clearInterval(orderFieldCheckInterval);
              // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«ä¸€åº¦è¨ˆç®—
              setTimeout(calculateOrderTotals, 100);
            } else if (orderFieldAttempts >= maxOrderFieldAttempts) {
              console.error('âŒ é…é€æ–™ã®inputãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼‰');
              clearInterval(orderFieldCheckInterval);
              // è¦‹ã¤ã‹ã‚‰ãªãã¦ã‚‚ä¸€åº¦è¨ˆç®—
              setTimeout(calculateOrderTotals, 100);
            }
          }, 200);
        })();

/ é‡‘é¡ã‚µãƒãƒªãƒ¼
.field-unit.col-md-12
  .field-unit__label.col-md-2 style='margin:0;'
    label å•†å“å°è¨ˆ
  .field-unit__field.col-md-10 style='margin: 0;'
    input.form-control.text-end.bg-secondary-subtle type="number" name="order[subtotal]" readonly="" value="#{f.object.subtotal}"

.field-unit.col-md-12
  .field-unit__label.col-md-2 style='margin:0;'
    label é…é€æ–™
  .field-unit__field.col-md-10 style='margin: 0;'
    input.form-control.text-end type="number" name="order[delivery_fee]" value="#{f.object.delivery_fee}"

.field-unit.col-md-12
  .field-unit__label.col-md-2 style='margin:0;'
    label å°è¨ˆ
  .field-unit__field.col-md-10 style='margin: 0;'
    input.form-control.text-end.bg-secondary-subtle type="number" id="calculated_subtotal" readonly="" value="#{f.object.subtotal.to_i + f.object.delivery_fee.to_i}"

.field-unit.col-md-12
  .field-unit__label.col-md-2 style='margin:0;'
    label 8%ç¨
  .field-unit__field.col-md-10 style='margin: 0;'
    input.form-control.text-end.bg-secondary-subtle type="number" name="order[tax_8_percent]" readonly="" value="#{f.object.tax_8_percent}"

.field-unit.col-md-12
  .field-unit__label.col-md-2 style='margin:0;'
    label 10%ç¨
  .field-unit__field.col-md-10 style='margin: 0;'
    input.form-control.text-end.bg-secondary-subtle type="number" id="calculated_tax_10_total" readonly="" value="#{f.object.tax_10_percent.to_i + f.object.delivery_fee_tax.to_i}"

.field-unit.col-md-12
  .field-unit__label.col-md-2 style='margin:0;'
    label æ¡ˆä»¶å‰²å¼•
  .field-unit__field.col-md-10 style='margin: 0;'
    input.form-control.text-end type="number" name="order[discount_amount]" value="#{f.object.discount_amount}" placeholder="0"

.field-unit.col-md-12
  .field-unit__label.col-md-2 style='margin:0;'
    label.fw-bold åˆè¨ˆ
  .field-unit__field.col-md-10 style='margin: 0;'
    input.form-control.text-end.bg-secondary-subtle.fw-bold type="number" name="order[total_price]" readonly="" value="#{f.object.total_price}"

/ éè¡¨ç¤ºãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
input type="hidden" name="order[tax_10_percent]" value="#{f.object.tax_10_percent}"
input type="hidden" name="order[delivery_fee_tax]" value="#{f.object.delivery_fee_tax}"
input type="hidden" name="order[tax]" value="#{f.object.tax}"

javascript:
  (function() {
    // é€ä¿¡ãƒœã‚¿ãƒ³ã«Bootstrapã‚¯ãƒ©ã‚¹ã‚’é©ç”¨
    setTimeout(() => {
      const submitButton = document.querySelector('input[type="submit"]');
      if (submitButton && !submitButton.classList.contains('btn')) {
        submitButton.classList.add('btn', 'btn-primary');
      }
    }, 100);
  })();
